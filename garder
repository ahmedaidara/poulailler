<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAKAR CHICKEN EXPRESS - Facturation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .code-inputs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .code-input {
            width: 70px;
            height: 80px;
            font-size: 2.5rem;
            text-align: center;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .code-input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error {
            color: #ff4757;
            margin-top: 15px;
            display: none;
        }
        
        /* Interface principale */
        .main-interface {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: 90vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid #667eea;
            padding: 30px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-5px);
        }
        
        .action-btn i {
            font-size: 2.5rem;
            color: #667eea;
        }
        
        .action-btn:hover i {
            color: white;
        }
        
        /* Page de facturation */
        .invoice-page {
            display: none;
        }
        
        .back-btn {
            background: #f0f0f0;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .client-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #555;
        }
        
        .input-group input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        /* Catégories */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .category-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .category-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .category-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .category-price {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .category-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: bold;
        }
        
        .category-input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        /* Résumé */
        .summary {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .actions {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-save {
            background: #10b981;
            color: white;
        }
        
        .btn-generate {
            background: #667eea;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
      
      /* Style pour la boutique active */
.boutique-active {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* Style boutique Sacré Coeur */
.boutique-sacre-coeur .header {
    border-left: 5px solid #3B82F6;
}

/* Style boutique Keur Massar */
.boutique-keur-massar .header {
    border-left: 5px solid #10B981;
}
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <img src="https://i.postimg.cc/0QBKNcGj/photo-5782651308169956527-x.jpg" alt="Logo" class="logo">
            <h1>DAKAR CHICKEN EXPRESS<br>Accès Gérante</h1>
            
            <div class="code-inputs">
                <input type="tel" class="code-input" maxlength="1" data-index="0">
                <input type="tel" class="code-input" maxlength="1" data-index="1">
                <input type="tel" class="code-input" maxlength="1" data-index="2">
                <input type="tel" class="code-input" maxlength="1" data-index="3">
            </div>
            
            <button id="loginBtn" class="login-btn">
                <i class="fas fa-lock-open"></i> Accéder
            </button>
            
            <div id="loginError" class="error">
                Code incorrect.
            </div>
        </div>
    </div>
    
    <!-- Interface principale -->
   <div id="mainInterface" class="main-interface">
    <div class="boutique-active" id="boutiqueIndicator" style="display: none;">
        <i class="fas fa-store"></i> <span id="currentBoutiqueName">...</span>
    </div>
        <div class="header">
            <div>
                <h2>DAKAR CHICKEN EXPRESS</h2>
                <p style="color: #666;">Module de facturation - Gérante</p>
            </div>
            <div style="color: #667eea; font-weight: bold;">
                <i class="fas fa-user"></i> Mode Gérante
            </div>
        </div>
        
        <div class="buttons-grid">
           <button id="selectProductionBtn" class="action-btn">
    <i class="fas fa-clipboard-list"></i>
    <span style="font-size: 1.2rem; font-weight: bold;">Nouvelle Facture</span>
    <small>Sélectionner d'abord une production</small>
</button>
            
            <button id="historyBtn" class="action-btn">
                <i class="fas fa-history"></i>
                <span style="font-size: 1.2rem; font-weight: bold;">Historique</span>
                <small>Voir les factures précédentes</small>
            </button>
            
            <button id="statsBtn" class="action-btn">
                <i class="fas fa-chart-bar"></i>
                <span style="font-size: 1.2rem; font-weight: bold;">Statistiques</span>
                <small>Analyser les ventes</small>
            </button>
        </div>
    </div>
    
    <!-- Page de facturation -->
    <div id="invoicePage" class="main-interface invoice-page">
        <button id="backBtn" class="back-btn">
            <i class="fas fa-arrow-left"></i> Retour
        </button>
        
        <h2 style="margin-bottom: 20px; color: #333;">Nouvelle Facture</h2>
        
        <!-- Informations client -->
        <div class="client-info">
            <h3 style="margin-bottom: 20px; color: #555;">
                <i class="fas fa-user-circle"></i> Informations Client
            </h3>
            <div class="info-grid">
                <div class="input-group">
                    <label for="clientName">Nom et Prénom</label>
                    <input type="text" id="clientName" placeholder="Ex: Moussa Diallo">
                </div>
                
                <div class="input-group">
                    <label for="clientPhone">Numéro de Téléphone</label>
                    <input type="tel" id="clientPhone" placeholder="Ex: 77 777 77 77">
                </div>
                
                <div class="input-group">
                    <label for="clientAddress">Adresse (Optionnel)</label>
                    <input type="text" id="clientAddress" placeholder="Ex: Dakar, Yoff">
                </div>
            </div>
        </div>
        
        <!-- Catégories de poulets -->
        <h3 style="margin-bottom: 20px; color: #555;">
            <i class="fas fa-shopping-cart"></i> Sélection des Poulets
        </h3>
        
        <div class="categories-grid" id="categoriesContainer">
            <!-- Les 8 catégories seront générées ici par JavaScript -->
        </div>
        
        <!-- Résumé de la commande -->
        <div class="summary">
            <h3 style="margin-bottom: 20px; color: #555;">
                <i class="fas fa-calculator"></i> Récapitulatif
            </h3>
            
            <div id="selectedItems">
                <!-- Les items sélectionnés apparaîtront ici -->
                <div style="text-align: center; color: #999; padding: 30px;">
                    <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>Aucun poulet sélectionné</p>
                </div>
            </div>
            
            <div class="summary-total">
                <span>TOTAL TTC</span>
                <span id="totalAmount" style="color: #667eea; font-size: 2rem;">0 F CFA</span>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="actions">
            <button id="saveBtn" class="btn btn-save">
                <i class="fas fa-save"></i> Enregistrer
            </button>
            
            <button id="generateBtn" class="btn btn-generate">
                <i class="fas fa-file-pdf"></i> Générer PDF
            </button>
        </div>
    </div>
<script>
        // Configuration Firebase (LA MÊME QUE VOTRE SITE PRINCIPAL)
        const firebaseConfig = {
            apiKey: "AIzaSyAAQ9G3w94aM7iGc_ufHMzdCvrwzzEzlhI",
            authDomain: "poulailler-3515e.firebaseapp.com",
            projectId: "poulailler-3515e",
            storageBucket: "poulailler-3515e.firebasestorage.app",
            messagingSenderId: "482441929117",
            appId: "1:482441929117:web:7970df401b0125560acf74",
            measurementId: "G-ZKH1QG9JW0"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Configuration multi-boutique
        const BOUTIQUE_CONFIG = {
            '8008': {
                id: 'sacre-coeur',
                name: 'SACRÉ COEUR 3',
                phone: '77 77 77 77 77',
                defaultCode: '8008'
            },
            '1001': {
                id: 'keur-massar', 
                name: 'KEUR MASSAR',
                phone: '77 77 77 77 78',
                defaultCode: '1001'
            }
        };
        
        // Variables globales
        let currentBoutique = null;
        let selectedItems = {};
        let currentInvoice = {
            id: null,
            client: {},
            items: [],
            total: 0,
            date: new Date()
        };
        
        // Données des catégories (LES MÊMES QUE VOTRE SITE)
        const categories = [
            { id: 1, name: "Très petits", weight: "1.0-1.1 kg", price: 2000 },
            { id: 2, name: "Petits", weight: "1.2 kg", price: 2500 },
            { id: 3, name: "Moyens-petits", weight: "1.3-1.4 kg", price: 3000 },
            { id: 4, name: "Moyens", weight: "1.5-1.6 kg", price: 3300 },
            { id: 5, name: "Moyens-grands", weight: "1.7-1.9 kg", price: 3500 },
            { id: 6, name: "Grands", weight: "2.0 kg", price: 3700 },
            { id: 7, name: "Très grands", weight: "2.1-2.3 kg", price: 4000 },
            { id: 8, name: "Géants", weight: "+2.4 kg", price: 4500 }
        ];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupCodeInputs();
            setupCategories();
            setupEventListeners();
        });
        
        // Configuration des inputs de code
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-input');
            
            inputs.forEach((input, index) => {
                if (index === 0) input.focus();
                
                input.addEventListener('input', function(e) {
                    if (this.value.length === 1) {
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    }
                     
                    // Vérifier si tous les champs sont remplis
                    const allFilled = Array.from(inputs).every(input => input.value.length === 1);
                    if (allFilled) {
                        setTimeout(handleLogin, 300);
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0) {
                        if (index > 0) {
                            inputs[index - 1].focus();
                        }
                    }
                });
            });
        }
        
        // Gestion de la connexion MULTI-BOUTIQUE
        function handleLogin() {
            const inputs = document.querySelectorAll('.code-input');
            const enteredCode = Array.from(inputs).map(input => input.value).join('');
            
            // Vérifier d'abord les codes locaux
            if (BOUTIQUE_CONFIG[enteredCode]) {
                currentBoutique = BOUTIQUE_CONFIG[enteredCode];
                loginSuccess();
                return;
            }
            
            // Sinon vérifier dans Firebase
            db.collection('poulailler_settings').doc('boutique_codes').get()
                .then(doc => {
                    if (doc.exists) {
                        const codes = doc.data();
                        
                        // Chercher quelle boutique correspond
                        if (codes.sacre_coeur === enteredCode) {
                            currentBoutique = BOUTIQUE_CONFIG['8008'];
                            loginSuccess();
                        } else if (codes.keur_massar === enteredCode) {
                            currentBoutique = BOUTIQUE_CONFIG['1001'];
                            loginSuccess();
                        } else {
                            showLoginError();
                        }
                    } else {
                        // Fallback aux codes par défaut
                        if (enteredCode === '8008' || enteredCode === '1001') {
                            currentBoutique = BOUTIQUE_CONFIG[enteredCode];
                            loginSuccess();
                        } else {
                            showLoginError();
                        }
                    }
                })
                .catch(() => {
                    // Fallback aux codes par défaut en cas d'erreur
                    if (enteredCode === '8008' || enteredCode === '1001') {
                        currentBoutique = BOUTIQUE_CONFIG[enteredCode];
                        loginSuccess();
                    } else {
                        showLoginError();
                    }
                });
        }
        
        // Connexion réussie
        function loginSuccess() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            
            // Mettre à jour l'interface avec le nom de la boutique
            document.querySelector('.header h2').innerHTML = 
                `DAKAR CHICKEN EXPRESS<br><small style="color: ${currentBoutique.id === 'sacre-coeur' ? '#3B82F6' : '#10B981'};">${currentBoutique.name}</small>`;
            
            showMessage(`Bienvenue - ${currentBoutique.name}`, 'success');
        }
        
        // Erreur de connexion
        function showLoginError() {
            document.getElementById('loginError').style.display = 'block';
            document.querySelectorAll('.code-input').forEach(input => {
                input.value = '';
                input.style.borderColor = '#ff4757';
            });
            document.querySelector('.code-input').focus();
            
            setTimeout(() => {
                document.querySelectorAll('.code-input').forEach(input => {
                    input.style.borderColor = '#e0e0e0';
                });
            }, 2000);
        }
        
        // Configuration des événements
    function setupEventListeners() {
    // Bouton de connexion
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    
    // CORRECTION ICI : Bouton pour nouvelle facture (sélection production)
    document.getElementById('selectProductionBtn').addEventListener('click', selectProductionForInvoice);
    
    // Bouton historique
    document.getElementById('historyBtn').addEventListener('click', function() {
        showBoutiqueHistory();
    });
    
    // Bouton statistiques
    document.getElementById('statsBtn').addEventListener('click', function() {
        showBoutiqueStats();
    });
    
    // Bouton retour (dans la page facturation)
    document.getElementById('backBtn').addEventListener('click', function() {
        document.getElementById('invoicePage').style.display = 'none';
        document.getElementById('mainInterface').style.display = 'block';
    });
    
    // Bouton enregistrer facture
    document.getElementById('saveBtn').addEventListener('click', saveInvoice);
    
    // Bouton générer PDF
    document.getElementById('generateBtn').addEventListener('click', generatePDF);
}
        
        // Configuration des catégories
        function setupCategories() {
            const container = document.getElementById('categoriesContainer');
            
            categories.forEach(category => {
                const categoryHTML = `
                    <div class="category-card">
                        <div class="category-header">
                            <div class="category-name">${category.id}. ${category.name}</div>
                            <div class="category-price">${category.price} F CFA</div>
                        </div>
                        <div style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                            ${category.weight}
                        </div>
                        <input type="number" 
                               class="category-input" 
                               id="cat-${category.id}"
                               data-id="${category.id}"
                               data-name="${category.name}"
                               data-weight="${category.weight}"
                               data-price="${category.price}"
                               min="0"
                               value="0"
                               placeholder="Quantité">
                    </div>
                `;
                
                container.innerHTML += categoryHTML;
            });
            
            // Ajouter les événements sur les inputs
            container.querySelectorAll('.category-input').forEach(input => {
                input.addEventListener('input', updateSummary);
            });
        }
        
        // Mettre à jour le résumé
        function updateSummary() {
            selectedItems = {};
            let total = 0;
            
            // Récupérer toutes les quantités
            document.querySelectorAll('.category-input').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const id = input.getAttribute('data-id');
                    const name = input.getAttribute('data-name');
                    const weight = input.getAttribute('data-weight');
                    const price = parseInt(input.getAttribute('data-price'));
                    
                    selectedItems[id] = {
                        id: id,
                        name: name,
                        weight: weight,
                        price: price,
                        quantity: quantity,
                        subtotal: quantity * price
                    };
                    
                    total += quantity * price;
                }
            });
            
            // Mettre à jour l'affichage du total
            document.getElementById('totalAmount').textContent = total.toLocaleString('fr-FR') + ' F CFA';
            
            // Mettre à jour la liste des items sélectionnés
            updateSelectedItemsList();
        }
        
        // Mettre à jour la liste des items sélectionnés
        function updateSelectedItemsList() {
            const container = document.getElementById('selectedItems');
            
            if (Object.keys(selectedItems).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 30px;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 10px;"></i>
                        <p>Aucun poulet sélectionné</p>
                    </div>
                `;
                return;
            }
            
            let itemsHTML = '';
            
            Object.values(selectedItems).forEach(item => {
                itemsHTML += `
                    <div class="summary-item">
                        <div>
                            <div style="font-weight: bold;">${item.name}</div>
                            <div style="color: #666; font-size: 0.9rem;">${item.weight}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${item.quantity} × ${item.price.toLocaleString('fr-FR')} F CFA</div>
                            <div style="font-weight: bold; color: #667eea;">
                                ${item.subtotal.toLocaleString('fr-FR')} F CFA
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = itemsHTML;
        }
        
        // Réinitialiser le formulaire de facture
        function resetInvoiceForm() {
            // Réinitialiser les inputs client
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            
            // Réinitialiser les quantités
            document.querySelectorAll('.category-input').forEach(input => {
                input.value = 0;
            });
            
            // Réinitialiser les variables
            selectedItems = {};
            currentInvoice = {
                id: null,
                boutique: currentBoutique.id,
                boutiqueName: currentBoutique.name,
                client: {},
                items: [],
                total: 0,
                date: new Date()
            };
            
            // Réinitialiser l'affichage
            document.getElementById('totalAmount').textContent = '0 F CFA';
            updateSelectedItemsList();
        }
        
        // Enregistrer la facture dans Firebase (AVEC BOUTIQUE)
    async function saveInvoice() {
    const clientName = document.getElementById('clientName').value.trim();
    const clientPhone = document.getElementById('clientPhone').value.trim();
    
    if (Object.keys(selectedItems).length === 0) {
        showMessage('Veuillez sélectionner au moins un poulet', 'error');
        return;
    }
    
    // VÉRIFIER LES STOCKS DISPONIBLES
    if (currentInvoice.productionData) {
        let stockInsuffisant = false;
        let messageErreur = '';
        
        Object.values(selectedItems).forEach(item => {
            const catKey = `cat${item.id}`;
            const soldKey = getSoldKeyForCategory(item.id);
            
            const stockInitial = currentInvoice.productionData.stock_disponible ? 
                               currentInvoice.productionData.stock_disponible[catKey] || 0 : 0;
            const dejaVendu = currentInvoice.productionData[soldKey] || 0;
            const disponible = stockInitial - dejaVendu;
            
            if (item.quantity > disponible) {
                stockInsuffisant = true;
                messageErreur += `\n${item.name}: disponible ${disponible}, demandé ${item.quantity}`;
            }
        });
        
        if (stockInsuffisant) {
            showMessage(`Stock insuffisant:${messageErreur}`, 'error');
            return;
        }
    }
    
    // Données de la facture
    const invoiceData = {
        boutique: currentBoutique.id,
        boutiqueName: currentBoutique.name,
        boutiquePhone: currentBoutique.phone,
        productionId: currentInvoice.productionId,
        productionDate: currentInvoice.productionData?.startDate,
        client: {
            name: clientName || 'Client non renseigné',
            phone: clientPhone || 'Non renseigné',
            address: document.getElementById('clientAddress').value.trim() || 'Non renseigné'
        },
        items: Object.values(selectedItems),
        total: parseInt(document.getElementById('totalAmount').textContent.replace(/\D/g, '')) || 0,
        date: firebase.firestore.FieldValue.serverTimestamp(),
        invoiceNumber: generateInvoiceNumber()
    };
    
    try {
        // SAUVEGARDER LA FACTURE
        const docRef = await db.collection('invoices').add(invoiceData);
        
        // METTRE À JOUR LES STOCKS DANS LA PRODUCTION
        if (currentInvoice.productionId) {
            await updateProductionStocks(currentInvoice.productionId, selectedItems);
        }
        
        // Mettre à jour l'objet facture
        currentInvoice = {
            ...invoiceData,
            id: docRef.id,
            date: new Date()
        };
        
        showMessage('Facture enregistrée et stocks mis à jour!', 'success');
        
        // Générer le PDF
        setTimeout(generatePDF, 1000);
        
    } catch (error) {
        console.error('Erreur:', error);
        showMessage("Erreur lors de l'enregistrement", 'error');
    }
}

// Fonction pour mettre à jour les stocks dans la production (VERSION CORRIGÉE)
async function updateProductionStocks(productionId, itemsSold) {
    try {
        const productionRef = db.collection('poulailler_records').doc(productionId);
        const productionDoc = await productionRef.get();
        
        if (!productionDoc.exists) return;
        
        const production = productionDoc.data();
        const updates = {};
        
        // Mapping des IDs de catégorie aux champs Firebase
        const categoryFields = {
            '1': 'small1Sold',
            '2': 'small2Sold', 
            '3': 'medium1Sold',
            '4': 'medium2Sold',
            '5': 'large1Sold',
            '6': 'large2Sold',
            '7': 'xlarge1Sold',
            '8': 'xlarge2Sold'
        };
        
        // Pour chaque catégorie vendue
        Object.values(itemsSold).forEach(item => {
            const soldField = categoryFields[item.id];
            if (soldField) {
                const currentSold = production[soldField] || 0;
                updates[soldField] = currentSold + item.quantity;
                
                // VÉRIFICATION DE STOCK : ne pas dépasser le stock initial
                const qtyField = soldField.replace('Sold', 'Quantity'); // small1Sold -> small1Quantity
                const stockInitial = production[qtyField] || 0;
                if (updates[soldField] > stockInitial) {
                    console.warn(`Attention: Ventes (${updates[soldField]}) > Stock initial (${stockInitial}) pour ${soldField}`);
                }
            }
        });
        
        // Ajouter la date de mise à jour
        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        updates.lastSaleDate = new Date().toISOString();
        
        // Mettre à jour
        await productionRef.update(updates);
        
        console.log('Stocks mis à jour avec succès');
        
    } catch (error) {
        console.error('Erreur mise à jour stocks:', error);
        throw error;
    }
}

// Fonction utilitaire pour obtenir la clé de vente
function getSoldKeyForCategory(categoryId) {
    const soldKeys = {
        '1': 'small1Sold',
        '2': 'small2Sold',
        '3': 'medium1Sold',
        '4': 'medium2Sold',
        '5': 'large1Sold',
        '6': 'large2Sold',
        '7': 'xlarge1Sold',
        '8': 'xlarge2Sold'
    };
    return soldKeys[categoryId] || 'small1Sold';
}
        
        // Générer un numéro de facture avec boutique
        function generateInvoiceNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const boutiquePrefix = currentBoutique.id === 'sacre-coeur' ? 'SC' : 'KM';
            
            return `FACT-${boutiquePrefix}-${year}${month}${day}-${random}`;
        }
        
        // Générer le PDF (AVEC BOUTIQUE)
        async function generatePDF() {
            if (Object.keys(selectedItems).length === 0 && currentInvoice.items.length === 0) {
                showMessage('Veuillez d\'abord enregistrer la facture', 'error');
                return;
            }
            
            // Utiliser les données sauvegardées ou actuelles
            const invoice = currentInvoice.id ? currentInvoice : {
                boutique: currentBoutique.id,
                boutiqueName: currentBoutique.name,
                boutiquePhone: currentBoutique.phone,
                client: {
                    name: document.getElementById('clientName').value.trim() || 'Client non renseigné',
                    phone: document.getElementById('clientPhone').value.trim() || 'Non renseigné',
                    address: document.getElementById('clientAddress').value.trim() || 'Non renseigné'
                },
                items: Object.values(selectedItems),
                total: parseInt(document.getElementById('totalAmount').textContent.replace(/\D/g, '')) || 0,
                date: new Date(),
                invoiceNumber: generateInvoiceNumber()
            };
            
            // Charger jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let currentY = 20;
            
            // EN-TÊTE AVEC BOUTIQUE
            // Logo
            try {
                const logoUrl = 'https://i.postimg.cc/0QBKNcGj/photo-5782651308169956527-x.jpg';
                doc.addImage(logoUrl, 'JPEG', margin, currentY, 30, 30);
            } catch (e) {
                // Si le logo ne charge pas, dessiner un carré
                doc.setFillColor(currentBoutique.id === 'sacre-coeur' ? [59, 130, 246] : [16, 185, 129]);
                doc.rect(margin, currentY, 30, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text(currentBoutique.id === 'sacre-coeur' ? "SC3" : "KM", margin + 15, currentY + 15, { align: 'center', baseline: 'middle' });
            }
            
            // Informations de l'entreprise AVEC BOUTIQUE
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("DAKAR CHICKEN EXPRESS", pageWidth / 2, currentY + 10, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(invoice.boutiqueName, pageWidth / 2, currentY + 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Tél: ${invoice.boutiquePhone}`, pageWidth / 2, currentY + 28, { align: 'center' });
            doc.text("Spécialiste en volailles de qualité", pageWidth / 2, currentY + 33, { align: 'center' });
            
            currentY += 45;
            
            // Informations client
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("FACTURE", margin, currentY);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`N°: ${invoice.invoiceNumber}`, pageWidth - margin, currentY, { align: 'right' });
            currentY += 10;
            
            doc.text(`Date: ${formatDate(invoice.date)}`, pageWidth - margin, currentY, { align: 'right' });
            currentY += 10;
            
            doc.text(`Heure: ${formatTime(invoice.date)}`, pageWidth - margin, currentY, { align: 'right' });
            currentY += 15;
            
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 10;
            
            // Informations client
            if (invoice.client.name !== 'Client non renseigné') {
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("CLIENT:", margin, currentY);
                
                doc.setFont("helvetica", "normal");
                currentY += 7;
                doc.text(`Nom: ${invoice.client.name}`, margin + 10, currentY);
                currentY += 5;
                
                if (invoice.client.phone !== 'Non renseigné') {
                    doc.text(`Tél: ${invoice.client.phone}`, margin + 10, currentY);
                    currentY += 5;
                }
                
                if (invoice.client.address !== 'Non renseigné') {
                    doc.text(`Adresse: ${invoice.client.address}`, margin + 10, currentY);
                    currentY += 5;
                }
                
                currentY += 10;
            }
            
            // DÉTAILS DE LA FACTURE
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DÉTAIL DE LA COMMANDE", margin, currentY);
            currentY += 10;
            
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 5;
            
            // En-tête du tableau
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("DESCRIPTION", margin, currentY);
            doc.text("QUANTITÉ", margin + 100, currentY);
            doc.text("PRIX UNIT.", margin + 130, currentY);
            doc.text("TOTAL", pageWidth - margin - 30, currentY, { align: 'right' });
            currentY += 7;
            
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 10;
            
            // Items (SEULEMENT ceux avec quantité ≥1)
            doc.setFont("helvetica", "normal");
            invoice.items.forEach(item => {
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.text(`${item.name} (${item.weight})`, margin, currentY);
                doc.text(item.quantity.toString(), margin + 100, currentY);
                doc.text(`${item.price.toLocaleString('fr-FR')} F CFA`, margin + 130, currentY);
                doc.text(`${item.subtotal.toLocaleString('fr-FR')} F CFA`, pageWidth - margin, currentY, { align: 'right' });
                
                currentY += 10;
            });
            
            currentY += 10;
            
            // Ligne de séparation
            doc.setDrawColor(100, 100, 100);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 15;
            
            // TOTAL
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("TOTAL TTC:", pageWidth - margin - 50, currentY);
            doc.text(`${invoice.total.toLocaleString('fr-FR')} F CFA`, pageWidth - margin, currentY, { align: 'right' });
            
            currentY += 20;
            
            // SIGNATURE
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Signature:", margin, currentY);
            currentY += 20;
            
            doc.setDrawColor(100, 100, 100);
            doc.line(margin, currentY, margin + 80, currentY);
            
            currentY += 10;
            
            // PIED DE PAGE
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Merci pour votre confiance !", pageWidth / 2, 280, { align: 'center' });
            doc.text(`${invoice.boutiqueName} - DAKAR CHICKEN EXPRESS`, pageWidth / 2, 285, { align: 'center' });
            
            // Sauvegarder le PDF
            const fileName = `Facture_${invoice.boutiqueName}_${invoice.invoiceNumber}.pdf`;
            doc.save(fileName);
            
            showMessage('PDF généré avec succès!', 'success');
        }
        
        // Formater la date
        function formatDate(date) {
            const d = new Date(date);
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }
        
        // Formater l'heure
        function formatTime(date) {
            const d = new Date(date);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }
        
        // Afficher un message
        function showMessage(text, type) {
            // Créer un élément message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#10b981' : '#ff4757'};
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            
            message.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${text}
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => message.remove(), 300);
            }, 3000);
            
            // Ajouter les animations CSS
            if (!document.querySelector('#message-animations')) {
                const style = document.createElement('style');
                style.id = 'message-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
  
// Afficher l'historique de la boutique (VERSION SIMPLE)
function showBoutiqueHistory() {
    if (!currentBoutique) {
        showMessage('Erreur: Boutique non reconnue', 'error');
        return;
    }
    
    // 1. Afficher un message de chargement
    showMessage('Chargement de l\'historique...', 'warning');
    
    // 2. Créer la fenêtre popup
    const modal = document.createElement('div');
    modal.id = 'historyModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; width: 100%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;">
                    <i class="fas fa-history"></i> Historique - ${currentBoutique.name}
                </h2>
                <button onclick="document.getElementById('historyModal').remove()" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyContent">
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                    <p>Chargement en cours...</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 3. Charger les factures (METHODE SIMPLE)
    db.collection('invoices')
        .get()  // On charge TOUTES les factures
        .then(snapshot => {
            console.log('Total factures trouvées:', snapshot.size);
            
            // Filtrer seulement les factures de CETTE boutique
            const facturesBoutique = [];
            
            snapshot.forEach(doc => {
                const facture = doc.data();
                if (facture.boutique === currentBoutique.id) {
                    facturesBoutique.push({
                        id: doc.id,
                        ...facture
                    });
                }
            });
            
            console.log('Factures de cette boutique:', facturesBoutique.length);
            
            // 4. Trier par date (plus récent d'abord)
            facturesBoutique.sort((a, b) => {
                // Date A
                let dateA;
                if (a.date && a.date.seconds) {
                    dateA = new Date(a.date.seconds * 1000);
                } else {
                    dateA = new Date(a.date || Date.now());
                }
                
                // Date B
                let dateB;
                if (b.date && b.date.seconds) {
                    dateB = new Date(b.date.seconds * 1000);
                } else {
                    dateB = new Date(b.date || Date.now());
                }
                
                // Comparer (plus récent d'abord)
                return dateB - dateA;
            });
            
            // 5. Afficher les résultats
            let html = '';
            
            if (facturesBoutique.length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-file-invoice" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>Aucune facture</h3>
                        <p>Créez votre première facture</p>
                    </div>
                `;
            } else {
                // Créer le tableau
                html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="padding: 10px; text-align: left;">N° Facture</th>
                                <th style="padding: 10px; text-align: left;">Date</th>
                                <th style="padding: 10px; text-align: left;">Client</th>
                                <th style="padding: 10px; text-align: right;">Montant</th>
                                <th style="padding: 10px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let totalCA = 0;
                
                facturesBoutique.forEach(facture => {
                    // Formater la date
                    let date;
                    if (facture.date && facture.date.seconds) {
                        date = new Date(facture.date.seconds * 1000);
                    } else {
                        date = new Date(facture.date || Date.now());
                    }
                    
                    const dateStr = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                    
                    totalCA += facture.total || 0;
                    
                    html += `
    <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 10px;">
            <strong>${facture.invoiceNumber || 'N/A'}</strong>
        </td>
        <td style="padding: 10px;">${dateStr}</td>
        <td style="padding: 10px;">${facture.client?.name || 'Anonyme'}</td>
        <td style="padding: 10px; text-align: right; font-weight: bold;">
            ${(facture.total || 0).toLocaleString('fr-FR')} F CFA
        </td>
        <td style="padding: 10px; text-align: center;">
            <!-- AJOUTEZ CES BOUTONS -->
            <button onclick="viewInvoiceFromHistory('${facture.id}')" 
                    style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">
                <i class="fas fa-eye"></i> Détails
            </button>
            <button onclick="regeneratePDF('${facture.id}')" 
                    style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </td>
    </tr>
`;
                });
                
                html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e6f7ff; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>Total:</strong> ${facturesBoutique.length} facture${facturesBoutique.length > 1 ? 's' : ''}</span>
                            <span><strong>CA total:</strong> ${totalCA.toLocaleString('fr-FR')} F CFA</span>
                        </div>
                    </div>
                `;
            }
            
            // 6. Afficher dans la modal
            document.getElementById('historyContent').innerHTML = html;
            
        }).catch(error => {
            console.error('Erreur:', error);
            
            document.getElementById('historyContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ff4757;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Erreur technique</h3>
                    <p>${error.message || 'Impossible de charger'}</p>
                    <button onclick="showBoutiqueHistory()" 
                            style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 15px;">
                        Réessayer
                    </button>
                </div>
            `;
        });
}

// Fonction 3ite gér ante
function viewInvoiceInGerante(invoiceId) {
    db.collection('invoices').doc(invoiceId).get()
        .then(doc => {
            if (!doc.exists) {
                showMessage('Facture non trouvée', 'error');
                return;
            }
            
            const invoice = doc.data();
            let date;
            
            if (invoice.date && invoice.date.seconds) {
                date = new Date(invoice.date.seconds * 1000);
            } else if (invoice.date) {
                date = new Date(invoice.date);
            } else {
                date = new Date();
            }
            
            let content = `
                <div style="background: white; padding: 25px; border-radius: 15px; max-width: 600px; margin: 0 auto;">
                    <h3 style="margin-bottom: 20px; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                        <i class="fas fa-file-invoice"></i> Facture ${invoice.invoiceNumber || ''}
                    </h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>Date:</strong> ${formatDate(date)} à ${formatTime(date)}</p>
                        <p><strong>Client:</strong> ${invoice.client?.name || 'Non renseigné'}</p>
                        <p><strong>Téléphone:</strong> ${invoice.client?.phone || '--'}</p>
                    </div>
                    
                    <h4 style="margin-bottom: 15px; color: #555;">Articles</h4>
            `;
            
            if (invoice.items && invoice.items.length > 0) {
                content += `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">`;
                
                invoice.items.forEach(item => {
                    content += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                            <div>
                                <strong>${item.name}</strong><br>
                                <small style="color: #666;">${item.weight}</small>
                            </div>
                            <div style="text-align: right;">
                                ${item.quantity} × ${item.price?.toLocaleString('fr-FR')} F CFA<br>
                                <strong>${item.subtotal?.toLocaleString('fr-FR')} F CFA</strong>
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
            }
            
            content += `
                    <div style="margin-top: 20px; padding: 15px; background: #667eea; color: white; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold;">
                            TOTAL: ${(invoice.total || 0).toLocaleString('fr-FR')} F CFA
                        </div>
                    </div>
                </div>
            `;
            
            // Afficher dans une modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #333;">Détails de la Facture</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        ${content}
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #e0e0e0; text-align: center;">
                        <button onclick="regeneratePDFFromInvoice('${invoiceId}')" 
                                style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-file-pdf"></i> Regénérer PDF
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i> Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
        }).catch(error => {
            console.error('Erreur chargement facture:', error);
            showMessage('Erreur chargement détail facture', 'error');
        });
}

// Fonction pour regénérer un PDF à partir d'une facture existante
function regeneratePDFFromInvoice(invoiceId) {
    db.collection('invoices').doc(invoiceId).get()
        .then(doc => {
            if (!doc.exists) return;
            
            const invoice = doc.data();
            currentInvoice = {
                ...invoice,
                id: invoiceId
            };
            
            generatePDF();
            showMessage('PDF en cours de génération...', 'success');
        })
        .catch(error => {
            console.error('Erreur:', error);
            showMessage('Erreur lors de la régénération', 'error');
        });
}

// Afficher les statistiques de la boutique
function showBoutiqueStats() {
    if (!currentBoutique) return;
    
    db.collection('invoices')
        .where('boutique', '==', currentBoutique.id)
        .get()
        .then(snapshot => {
            let totalFactures = snapshot.size;
            let totalCA = 0;
            let totalPoulets = 0;
            let clientsUniques = new Set();
            
            snapshot.forEach(doc => {
                const invoice = doc.data();
                totalCA += invoice.total || 0;
                
                // Compter les poulets
                if (invoice.items) {
                    invoice.items.forEach(item => {
                        totalPoulets += item.quantity || 0;
                    });
                }
                
                //  
                if (invoice.client?.name && invoice.client.name !== 'Client non renseigné') {
                    clientsUniques.add(invoice.client.name);
                }
            });
            
            const avgPanier = totalFactures > 0 ? totalCA / totalFactures : 0;
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-chart-bar"></i> Statistiques - ${currentBoutique.name}
                    </h3>
                     
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${totalFactures}</div>
                            <div style="color: #666;">Factures totales</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #10b981;">${totalCA.toLocaleString('fr-FR')}</div>
                            <div style="color: #666;">Chiffre d'affaires (F CFA)</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${totalPoulets}</div>
                            <div style="color: #666;">Poulets vendus</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">${clientsUniques.size}</div>
                            <div style="color: #666;">Clients  </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px; color: #555;">Panier moyen</h4>
                        <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color: #333;">
                            ${avgPanier.toLocaleString('fr-FR')} F CFA
                        </div>
                    </div>
                </div>
            `;
            
            // Créer une modal pour afficher les stats
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 100%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-chart-bar"></i> Statistiques
                        </h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${html}
                </div>
            `;
            
            document.body.appendChild(modal);
        })
        .catch(error => {
            console.error('Erreur statistiques:', error);
            showMessage('Erreur chargement statistiques', 'error');
        });
}
  
  // ==============================================
// FONCTIONS POUR L'HISTORIQUE (VERSION SIMPLE)
// ==============================================

// Fonction pour voir les détails d'une facture depuis l'historique
function viewInvoiceFromHistory(invoiceId) {
    console.log('Voir facture:', invoiceId);
    
    db.collection('invoices').doc(invoiceId).get()
        .then(doc => {
            if (!doc.exists) {
                showMessage('Facture non trouvée', 'error');
                return;
            }
            
            const invoice = doc.data();
            showSimpleInvoiceModal(invoice, invoiceId);
            
        }).catch(error => {
            console.error('Erreur:', error);
            showMessage('Erreur de chargement', 'error');
        });
}

// Fonction simple pour afficher les détails
function showSimpleInvoiceModal(invoice, invoiceId) {
    // Formater la date
    let date;
    if (invoice.date && invoice.date.seconds) {
        date = new Date(invoice.date.seconds * 1000);
    } else {
        date = new Date(invoice.date || Date.now());
    }
    
    const dateStr = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
    
    // Créer le HTML simple
    let itemsHTML = '';
    if (invoice.items && invoice.items.length > 0) {
        invoice.items.forEach(item => {
            itemsHTML += `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <div>${item.name} (${item.weight})</div>
                    <div>${item.quantity} × ${item.price?.toLocaleString('fr-FR')} = <strong>${item.subtotal?.toLocaleString('fr-FR')} F CFA</strong></div>
                </div>
            `;
        });
    }
    
    // Modal HTML
    const modalHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px;">
            <div style="background: white; border-radius: 10px; padding: 20px; width: 100%; max-width: 500px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #333;">Facture ${invoice.invoiceNumber || ''}</h3>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <p><strong>Date:</strong> ${dateStr}</p>
                    <p><strong>Client:</strong> ${invoice.client?.name || 'Non renseigné'}</p>
                    <p><strong>Téléphone:</strong> ${invoice.client?.phone || '--'}</p>
                </div>
                
                <div style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
                    ${itemsHTML || '<p>Aucun article</p>'}
                </div>
                
                <div style="border-top: 2px solid #333; padding-top: 10px; font-size: 1.2rem; font-weight: bold; text-align: right;">
                    TOTAL: ${(invoice.total || 0).toLocaleString('fr-FR')} F CFA
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="generatePDFFromHistory('${invoiceId}')" 
                            style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-file-pdf"></i> Générer PDF
                    </button>
                    <button onclick="closeModal()" 
                            style="flex: 1; background: #666; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Ajouter au body
    const modalDiv = document.createElement('div');
    modalDiv.id = 'simpleInvoiceModal';
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
}

// Fonction pour fermer la modal
function closeModal() {
    const modal = document.getElementById('simpleInvoiceModal');
    if (modal) modal.remove();
}

// ==============================================
// FONCTION PRINCIPALE POUR GÉNÉRER LE PDF
// ==============================================

// Fonction pour générer le PDF depuis l'historique (UTILISE LA MÊME FONCTION)
function generatePDFFromHistory(invoiceId) {
    console.log('Générer PDF depuis historique:', invoiceId);
    
    showMessage('Préparation du PDF...', 'warning');
    
    db.collection('invoices').doc(invoiceId).get()
        .then(doc => {
            if (!doc.exists) {
                showMessage('Facture non trouvée', 'error');
                return;
            }
            
            const invoice = doc.data();
            
            // 1. Fermer toutes les modals ouvertes
            closeModal();
            const historyModal = document.getElementById('historyModal');
            if (historyModal) historyModal.remove();
            
            // 2. Préparer les données exactement comme une nouvelle facture
            prepareInvoiceForPDF(invoice);
            
            // 3. Générer le PDF IMMÉDIATEMENT (même fonction que pour nouvelle facture)
            generatePDFDirect();
            
        }).catch(error => {
            console.error('Erreur:', error);
            showMessage('Erreur lors de la génération du PDF', 'error');
        });
}

// Préparer les données pour le PDF
function prepareInvoiceForPDF(invoice) {
    // Réinitialiser les items sélectionnés
    selectedItems = {};
    
    // Remplir selectedItems comme si c'était une nouvelle facture
    if (invoice.items && invoice.items.length > 0) {
        invoice.items.forEach(item => {
            // Trouver l'ID de la catégorie correspondante
            const catId = findCategoryId(item.name);
            if (catId) {
                selectedItems[catId] = {
                    id: catId,
                    name: item.name,
                    weight: item.weight,
                    price: item.price,
                    quantity: item.quantity,
                    subtotal: item.subtotal
                };
            }
        });
    }
    
    // Mettre à jour currentInvoice
    currentInvoice = {
        ...invoice,
        items: invoice.items || [],
        total: invoice.total || 0
    };
    
    // Mettre à jour l'affichage du total (optionnel)
    document.getElementById('totalAmount').textContent = (invoice.total || 0).toLocaleString('fr-FR') + ' F CFA';
    updateSelectedItemsList();
}

// Trouver l'ID de catégorie par nom
function findCategoryId(name) {
    const categoriesMap = {
        'Très petits': '1',
        'Petits': '2', 
        'Moyens-petits': '3',
        'Moyens': '4',
        'Moyens-grands': '5',
        'Grands': '6',
        'Très grands': '7',
        'Géants': '8'
    };
    
    // Chercher par nom complet ou partiel
    for (const [key, value] of Object.entries(categoriesMap)) {
        if (name.includes(key)) {
            return value;
        }
    }
    
    // Fallback: premier mot
    const firstWord = name.split(' ')[0];
    return categoriesMap[firstWord] || '1';
}

// ==============================================
// FONCTION DIRECTE POUR GÉNÉRER LE PDF
// ==============================================

// Version directe de generatePDF() sans vérifications
function generatePDFDirect() {
    if (!currentInvoice || (!currentInvoice.items && Object.keys(selectedItems).length === 0)) {
        showMessage('Aucune donnée pour générer le PDF', 'error');
        return;
    }
    
    // Utiliser les données de currentInvoice
    const invoice = currentInvoice;
    
    // Charger jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    let currentY = 20;
    
    // EN-TÊTE AVEC BOUTIQUE
    try {
        const logoUrl = 'https://i.postimg.cc/0QBKNcGj/photo-5782651308169956527-x.jpg';
        doc.addImage(logoUrl, 'JPEG', margin, currentY, 30, 30);
    } catch (e) {
        doc.setFillColor(59, 130, 246);
        doc.rect(margin, currentY, 30, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.text(invoice.boutique === 'sacre-coeur' ? "SC3" : "KM", margin + 15, currentY + 15, { align: 'center', baseline: 'middle' });
    }
    
    // Titre
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.text("DAKAR CHICKEN EXPRESS", pageWidth / 2, currentY + 10, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(invoice.boutiqueName || (invoice.boutique === 'sacre-coeur' ? 'SACRÉ COEUR 3' : 'KEUR MASSAR'), pageWidth / 2, currentY + 20, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Tél: ${invoice.boutiquePhone || '77 77 77 77 77'}`, pageWidth / 2, currentY + 28, { align: 'center' });
    
    currentY += 45;
    
    // Informations facture
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("FACTURE", margin, currentY);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`N°: ${invoice.invoiceNumber || 'N/A'}`, pageWidth - margin, currentY, { align: 'right' });
    currentY += 10;
    
    // Date
    let date;
    if (invoice.date && invoice.date.seconds) {
        date = new Date(invoice.date.seconds * 1000);
    } else {
        date = new Date(invoice.date || Date.now());
    }
    
    doc.text(`Date: ${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`, pageWidth - margin, currentY, { align: 'right' });
    currentY += 10;
    doc.text(`Heure: ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`, pageWidth - margin, currentY, { align: 'right' });
    currentY += 15;
    
    // Ligne
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 10;
    
    // Informations client
    if (invoice.client && invoice.client.name && invoice.client.name !== 'Client non renseigné') {
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.text("CLIENT:", margin, currentY);
        
        doc.setFont("helvetica", "normal");
        currentY += 7;
        doc.text(`Nom: ${invoice.client.name}`, margin + 10, currentY);
        currentY += 5;
        
        if (invoice.client.phone && invoice.client.phone !== 'Non renseigné') {
            doc.text(`Tél: ${invoice.client.phone}`, margin + 10, currentY);
            currentY += 5;
        }
        
        if (invoice.client.address && invoice.client.address !== 'Non renseigné') {
            doc.text(`Adresse: ${invoice.client.address}`, margin + 10, currentY);
            currentY += 5;
        }
        
        currentY += 10;
    }
    
    // DÉTAILS
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("DÉTAIL DE LA COMMANDE", margin, currentY);
    currentY += 10;
    
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 5;
    
    // En-tête tableau
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("DESCRIPTION", margin, currentY);
    doc.text("QUANTITÉ", margin + 100, currentY);
    doc.text("PRIX UNIT.", margin + 130, currentY);
    doc.text("TOTAL", pageWidth - margin - 30, currentY, { align: 'right' });
    currentY += 7;
    
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 10;
    
    // Articles
    doc.setFont("helvetica", "normal");
    if (invoice.items && invoice.items.length > 0) {
        invoice.items.forEach(item => {
            if (currentY > 250) {
                doc.addPage();
                currentY = 20;
            }
            
            doc.text(`${item.name} (${item.weight})`, margin, currentY);
            doc.text(item.quantity.toString(), margin + 100, currentY);
            doc.text(`${item.price.toLocaleString('fr-FR')} F CFA`, margin + 130, currentY);
            doc.text(`${item.subtotal.toLocaleString('fr-FR')} F CFA`, pageWidth - margin, currentY, { align: 'right' });
            
            currentY += 10;
        });
    }
    
    currentY += 10;
    
    // Ligne de séparation
    doc.setDrawColor(100, 100, 100);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 15;
    
    // TOTAL
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("TOTAL TTC:", pageWidth - margin - 50, currentY);
    doc.text(`${invoice.total.toLocaleString('fr-FR')} F CFA`, pageWidth - margin, currentY, { align: 'right' });
    
    currentY += 20;
    
     doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("Signature:", margin, currentY);
    currentY += 20;
    
    doc.setDrawColor(100, 100, 100);
    doc.line(margin, currentY, margin + 80, currentY);
    
     doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text("Merci pour votre confiance !", pageWidth / 2, 280, { align: 'center' });
    doc.text("DAKAR CHICKEN EXPRESS", pageWidth / 2, 285, { align: 'center' });
    
     const fileName = `Facture_${invoice.invoiceNumber || 'recu'}.pdf`;
    doc.save(fileName);
    
    showMessage('PDF généré avec succès!', 'success');
}
  
  
function selectProductionForInvoice() {
    if (!currentBoutique) {
        showMessage('Veuillez d\'abord vous connecter', 'error');
        return;
    }
    
    // Afficher le chargement
    showMessage('Chargement des productions disponibles...', 'warning');
    
    // Charger les productions du site principal
    db.collection('poulailler_records')
        .orderBy('startDate', 'desc')
        .limit(20)
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                showMessage('Aucune production disponible', 'error');
                return;
            }
            
            // Créer la modal de sélection
            const modal = document.createElement('div');
            modal.id = 'selectProductionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 20px;
            `;
            
            let productionsHTML = '';
            snapshot.forEach(doc => {
                const production = doc.data();
                const date = new Date(production.startDate);
                const dateStr = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth()+1).padStart(2, '0')}/${date.getFullYear()}`;
                
                // LES 8 CATÉGORIES COMME DANS L'ANCIEN SITE
                const categories = [
                    { id: 1, name: 'Très P', qtyField: 'small1Quantity', soldField: 'small1Sold', priceField: 'small1Price' },
                    { id: 2, name: 'Petits', qtyField: 'small2Quantity', soldField: 'small2Sold', priceField: 'small2Price' },
                    { id: 3, name: 'Moy-P', qtyField: 'medium1Quantity', soldField: 'medium1Sold', priceField: 'medium1Price' },
                    { id: 4, name: 'Moyens', qtyField: 'medium2Quantity', soldField: 'medium2Sold', priceField: 'medium2Price' },
                    { id: 5, name: 'Moy-G', qtyField: 'large1Quantity', soldField: 'large1Sold', priceField: 'large1Price' },
                    { id: 6, name: 'Grands', qtyField: 'large2Quantity', soldField: 'large2Sold', priceField: 'large2Price' },
                    { id: 7, name: 'Très G', qtyField: 'xlarge1Quantity', soldField: 'xlarge1Sold', priceField: 'xlarge1Price' },
                    { id: 8, name: 'Géants', qtyField: 'xlarge2Quantity', soldField: 'xlarge2Sold', priceField: 'xlarge2Price' }
                ];
                
                // CALCULER CORRECTEMENT LE STOCK
                let stockTotal = 0;      // Stock initial total
                let disponibleTotal = 0; // Total disponible pour vente
                let venduTotal = 0;      // Total déjà vendu
                
                categories.forEach(cat => {
                    const stockInitial = production[cat.qtyField] || 0;
                    const dejaVendu = production[cat.soldField] || 0;
                    const disponible = Math.max(0, stockInitial - dejaVendu);
                    
                    stockTotal += stockInitial;
                    disponibleTotal += disponible;
                    venduTotal += dejaVendu;
                });
                
                // Calculer le stock restant réel (initial - vendus - perdus/donnés)
                const totalSold = venduTotal;
                const totalLostGiven = (production.lost || 0) + (production.given || 0);
                const stockRestant = Math.max(0, stockTotal - totalSold - totalLostGiven);
                
                productionsHTML += `
                    <div class="production-card" data-id="${doc.id}" 
                         style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: bold; color: #333;">Production du ${dateStr}</div>
                                <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                    <span style="color: ${disponibleTotal > 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                                        ${disponibleTotal} poulets disponibles pour vente
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                                    Stock initial: ${stockTotal} | Déjà vendus: ${venduTotal} | Perdus/donnés: ${totalLostGiven}
                                </div>
                                <div style="font-size: 0.8rem; color: #3b82f6; margin-top: 3px; font-weight: bold;">
                                    Stock restant réel: ${stockRestant}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: #f0f9ff; color: #0369a1; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; font-weight: bold;">
                                    ${stockTotal} initial
                                </div>
                                
                            </div>
                        </div>
                        
                        <!-- AFFICHAGE DÉTAILLÉ PAR CATÉGORIE -->
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 0.8rem;">
                `;
                
               
                
                productionsHTML += `
                            </div>
                        </div>
                        
                        <!-- STATUS DE LA PRODUCTION -->
                       
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-seedling"></i> Sélectionner une Production
                        </h2>
                        <button onclick="document.getElementById('selectProductionModal').remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px; color: #666;">
                        <p>Sélectionnez la production pour laquelle vous voulez créer une facture :</p>
                        <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; gap: 10px;">
                           
                        </div>
                    </div>
                    
                    <div id="productionsList" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                        ${productionsHTML}
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('selectProductionModal').remove()" 
                                style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            Annuler
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ajouter les événements de clic
            document.querySelectorAll('.production-card').forEach(card => {
                card.addEventListener('click', function() {
                    const productionId = this.getAttribute('data-id');
                    loadProductionForInvoice(productionId);
                });
                
                // Effet hover
                card.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.1)';
                    this.style.transform = 'translateY(-2px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                    this.style.transform = 'translateY(0)';
                });
            });
            
        }).catch(error => {
            console.error('Erreur chargement productions:', error);
            showMessage('Erreur de chargement des productions', 'error');
        });
}

function calculateProductionRevenue(production) {
    // CALCULER LE REVENU DE TOUTES LES 8 CATÉGORIES
    const revenue = (production.small1Sold || 0) * (production.small1Price || 2000) +
                   (production.small2Sold || 0) * (production.small2Price || 2500) +
                   (production.medium1Sold || 0) * (production.medium1Price || 3000) +
                   (production.medium2Sold || 0) * (production.medium2Price || 3300) +
                   (production.large1Sold || 0) * (production.large1Price || 3500) +
                   (production.large2Sold || 0) * (production.large2Price || 3700) +
                   (production.xlarge1Sold || 0) * (production.xlarge1Price || 4000) +
                   (production.xlarge2Sold || 0) * (production.xlarge2Price || 4500);
    
    return revenue;
}
// Fonction pour charger une production spécifique
function loadProductionForInvoice(productionId) {
    console.log('Chargement production:', productionId);
    
    showMessage('Chargement des données de production...', 'warning');
    
    db.collection('poulailler_records').doc(productionId).get()
        .then(doc => {
            if (!doc.exists) {
                showMessage('Production non trouvée', 'error');
                return;
            }
            
            const production = doc.data();
            
            // Fermer la modal de sélection
            const modal = document.getElementById('selectProductionModal');
            if (modal) modal.remove();
            
            // Ouvrir la page de facturation avec les données pré-remplies
            openInvoicePageWithProduction(production, productionId);
            
        }).catch(error => {
            console.error('Erreur:', error);
            showMessage('Erreur de chargement', 'error');
        });
}

// Ouvrir la page de facturation avec les données de production
function openInvoicePageWithProduction(production, productionId) {
    // Stocker l'ID de production
    currentInvoice.productionId = productionId;
    currentInvoice.productionData = production;
    
    // Afficher la page de facturation
    document.getElementById('mainInterface').style.display = 'none';
    document.getElementById('invoicePage').style.display = 'block';
    
    // Réinitialiser le formulaire
    resetInvoiceForm();
    
    // Pré-remplir avec les prix de la production
    if (production.small1Price) document.getElementById('cat-1').setAttribute('data-price', production.small1Price);
    if (production.small2Price) document.getElementById('cat-2').setAttribute('data-price', production.small2Price);
    if (production.medium1Price) document.getElementById('cat-3').setAttribute('data-price', production.medium1Price);
    if (production.medium2Price) document.getElementById('cat-4').setAttribute('data-price', production.medium2Price);
    if (production.large1Price) document.getElementById('cat-5').setAttribute('data-price', production.large1Price);
    if (production.large2Price) document.getElementById('cat-6').setAttribute('data-price', production.large2Price);
    if (production.xlarge1Price) document.getElementById('cat-7').setAttribute('data-price', production.xlarge1Price);
    if (production.xlarge2Price) document.getElementById('cat-8').setAttribute('data-price', production.xlarge2Price);
    
    // Afficher les stocks disponibles
    showAvailableStock(production);
    
    showMessage('Production chargée avec succès', 'success');
}

  
// Fonction pour afficher les stocks disponibles (VERSION CORRIGÉE)
function showAvailableStock(production) {
    const stockInfo = document.createElement('div');
    stockInfo.id = 'stockInfo';
    stockInfo.style.cssText = `
        background: #f0f9ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #3b82f6;
    `;
    
    // CALCULER LE STOCK TOTAL CORRECTEMENT
   const stockTotal = production.initialStock || 0;

    
    let stockHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="margin: 0; color: #0369a1;">
                    <i class="fas fa-boxes-stacked"></i> Stocks Disponibles
                </h4>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">
                    Production du ${formatDate(production.startDate)}
                </p>
            </div>
            <div style="background: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0369a1;">
                Stock initial: ${stockTotal}
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
    `;
    
    // LES 8 CATÉGORIES COMME DA'ANCIEN SITE
    const categories = [
        { 
            id: 1, 
            name: 'Très petits', 
            weight: '1-1.1 kg',
            qtyField: 'small1Quantity',
            soldField: 'small1Sold',
            priceField: 'small1Price'
        },
        { 
            id: 2, 
            name: 'Petits', 
            weight: '1.2 kg',
            qtyField: 'small2Quantity', 
            soldField: 'small2Sold',
            priceField: 'small2Price'
        },
        { 
            id: 3, 
            name: 'Moyens-petits', 
            weight: '1.3-1.4 kg',
            qtyField: 'medium1Quantity', 
            soldField: 'medium1Sold',
            priceField: 'medium1Price'
        },
        { 
            id: 4, 
            name: 'Moyens', 
            weight: '1.5-1.6 kg',
            qtyField: 'medium2Quantity', 
            soldField: 'medium2Sold',
            priceField: 'medium2Price'
        },
        { 
            id: 5, 
            name: 'Moyens-grands', 
            weight: '1.7-1.9 kg',
            qtyField: 'large1Quantity', 
            soldField: 'large1Sold',
            priceField: 'large1Price'
        },
        { 
            id: 6, 
            name: 'Grands', 
            weight: '2 kg',
            qtyField: 'large2Quantity', 
            soldField: 'large2Sold',
            priceField: 'large2Price'
        },
        { 
            id: 7, 
            name: 'Très grands', 
            weight: '2.1-2.3 kg',
            qtyField: 'xlarge1Quantity', 
            soldField: 'xlarge1Sold',
            priceField: 'xlarge1Price'
        },
        { 
            id: 8, 
            name: 'Géants', 
            weight: '+2.4 kg',
            qtyField: 'xlarge2Quantity', 
            soldField: 'xlarge2Sold',
            priceField: 'xlarge2Price'
        }
    ];
    
    categories.forEach(cat => {
 const stockInitial = production[cat.qtyField] || 0;  // Ex: small1Quantity
const dejaVendu = production[cat.soldField] || 0;    // Ex: small1Sold
const disponible = Math.max(0, stockInitial - dejaVendu);
        const prix = production[cat.priceField] || 0;
        
        stockHTML += `
            <div style="text-align: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <div style="font-size: 0.9rem; font-weight: bold; color: #333; margin-bottom: 5px;">
                    ${cat.name}
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">
                    ${cat.weight}
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 3px;">
                    <span style="color: #666;">Initial:</span>
                    <span style="font-weight: bold;">${stockInitial}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 3px;">
                    <span style="color: #666;">Vendu:</span>
                    <span style="color: #ef4444;">${dejaVendu}</span>
                </div>
                <div style="border-top: 1px solid #e0e0e0; padding-top: 5px; margin-top: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #666; font-size: 0.8rem;">Dispo:</span>
                        <span style="font-weight: bold; color: ${disponible > 0 ? '#10b981' : '#ef4444'}; font-size: 1.1rem;">
                            ${disponible}
                        </span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.8rem; color: #3b82f6; text-align: right;">
                        ${prix.toLocaleString('fr-FR')} F CFA
                    </div>
                </div>
            </div>
        `;
    });
    
    stockHTML += `</div>`;
    
    // Calculer le total disponible
   // CALCUL DU STOCK RÉEL RESTANT (comme site principal)
const stockInitialTotal = production.initialStock || 0;
const totalVendu = categories.reduce((sum, cat) => {
    return sum + (production[cat.soldField] || 0);
}, 0);

const totalPerduDonne = (production.lost || 0) + (production.given || 0);
const stockReelRestant = Math.max(0, stockInitialTotal - totalVendu - totalPerduDonne);

const totalDisponible = stockReelRestant; // ← Utilisez le stock réel
    // CALCUL DU STOCK RÉEL ET SA VALEUR
const stockReel = Math.max(0, (production.initialStock || 0) - 
    ((production.small1Sold || 0) + (production.small2Sold || 0) + 
     (production.medium1Sold || 0) + (production.medium2Sold || 0) +
     (production.large1Sold || 0) + (production.large2Sold || 0) +
     (production.xlarge1Sold || 0) + (production.xlarge2Sold || 0)) -
    ((production.lost || 0) + (production.given || 0)));

// Valeur estimée (prix moyen × stock réel)
const prixMoyen = 3000; // Prix moyen estimé
const valeurEstimee = stockReel * prixMoyen;

// Puis utilisez stockReel au lieu de totalDisponible
    // Ajouter un résumé
    stockHTML += `
        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #3b82f6; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: bold; color: #333;">
                <i class="fas fa-chart-bar"></i> RÉSUMÉ
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: #666;">Stock restant réel</div>
<div style="font-size: 1.2rem; font-weight: bold; color: #3b82f6;">
    ${stockReel} poulets
</div>
<div style="font-size: 0.8rem; color: #10b981; margin-top: 5px;">
    ≈ ${valeurEstimee.toLocaleString('fr-FR')} F CFA
</div>
            </div>
        </div>
    `;
    
    // Avertissement si stock épuisé
    if (totalDisponible <= 0) {
        stockHTML += `
            <div style="margin-top: 10px; padding: 10px; background: #fee2e2; color: #dc2626; border-radius: 5px; text-align: center; font-weight: bold;">
                <i class="fas fa-exclamation-triangle"></i> Stock épuisé !
            </div>
        `;
    }
    
    stockInfo.innerHTML = stockHTML;
    
    // Insérer au début de la page de facturation
    const invoicePage = document.getElementById('invoicePage');
    const firstChild = invoicePage.children[0];
    invoicePage.insertBefore(stockInfo, firstChild.nextSibling);
    
    // METTRE À JOUR LES PRIX DANS LES INPUTS
    categories.forEach(cat => {
        const input = document.getElementById(`cat-${cat.id}`);
        if (input) {
            const prix = production[cat.priceField] || categories[cat.id-1].price; // Prix par défaut
            input.setAttribute('data-price', prix);
            
            // Mettre à jour l'affichage du prix dans la carte
            const card = input.closest('.category-card');
            if (card) {
                const priceElement = card.querySelector('.category-price');
                if (priceElement) {
                    priceElement.textContent = `${prix.toLocaleString('fr-FR')} F CFA`;
                }
            }
        }
    });
}

 
    </script>
   
</body>
</html>
